{% extends 'default_e_bell.html' %}

{% set nav_title='Doorbell' %}

{% block e_bell_content %}
    <div class="align-items-baseline d-flex doorbell flex-wrap justify-content-evenly h-100">
        <div class="card doorbell-detail-container mt-5 mx-2">
            <div class="card-body doorbell-detail-title ">
                <h2 class="card-title text-center">Stream</h2>
            </div>
            <div class="align-self-center card-img w-auto m-3">
                <object
                        width="320"
                        height="240"
                        class="img-fluid"
                        data="{{ doorbell.image }}"
                        {% if doorbell.online == True %}
                        id="stream-view"
                        url="{{ url_for('stream', uuid=doorbell.id) }}"
                        {% endif %}
                        type='image/jpeg'>
                </object>
            </div>
            <div class="card-body d-flex flex-nowrap justify-content-evenly text-center w-auto">
                <button class="border-0 btn btn-cyan p-2 text-white w-35" onclick="takePic()" type="button">
                    Take Picture
                </button>
                <button class="border-0 btn btn-violet p-2 text-white w-35" onclick="openDoor()" type="button">
                    Open Door
                </button>
            </div>
        </div>
        <div class="card doorbell-detail-container my-5 mx-2">
            <div class="doorbell-detail-title card-body">
                <h2 class="card-title text-center">Details</h2>
            </div>
            <div class="card-body">
                <form action="{{ url_for('doorbell', uuid=doorbell.id) }}" onsubmit="preventDefault()" method="POST">
                    <div class="form-group">
                        <label for="doorbell-name">Doorbell Name</label>
                        <input autocomplete="on" class="form-control" id="doorbell-name" name="doorbell-name"
                               placeholder="{{ doorbell.name }}" value="{{ doorbell.name }}" type="text"/>
                    </div>
                    <div class="form-group">
                        <label for="alert-emails">Emails to alert</label>
                        <textarea class="form-control"
                                  id="alert-emails"
                                  name="alert-emails">{{ doorbell.emails }}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="password">Password Confirmation</label>
                        <input autocomplete="current-password" class="form-control" id="password" placeholder="Password"
                               name="password"
                               type="password">
                    </div>
                    <div class="d-flex flex-nowrap justify-content-evenly m-2 mt-4 text-center">
                        <button class="border-0 btn btn-green p-2 text-white w-25" type="submit">Submit</button>
                        <button class="border-0 btn btn-red p-2 text-white w-25" type="reset">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!--
        <div class="row">
            <div class="col-sm-6 col-md-4 col-lg-3 image-container">
               {# {% for path in paths %} #}
            <div class="col-sm-6 col-md-4 col-lg-3 image-container">
              <figure>
                  {# {% if ".mp4" in path %} #}
                    <div class="pic image"><video src='{# {{ path }} #}' class="img-thumbnail"></div>
                  {# {% else %} #}
                    <div class="pic image"><img src='{# {{ path }} #}' class="img-thumbnail"></div>
                  {# {% endif %}   #}
                  <figcaption>
                    {# {{ doorbells[loop.index0]}} #}</br>
                    {# {{ dates[loop.index0]}} #}
                  </figcaption>
              </figure>


            </div>
          {# {% endfor %} #}
            </div>-->
    </div>
    <div class="popup-pic" id="popup-container">
        <span id="popup-pic-close-button">&times;</span>
        <img alt="Bigger image selected by user" id="popup-image" src="{{ doorbell.image }}">
    </div>
{% endblock %}

{% block scripts %}
    <script>
        /*
                const popup = document.getElementById('popup-container');
                const popupClose = document.getElementById('popup-pic-close-button');
                popupClose.addEventListener('click', () => popup.style.display = 'none');

                        document.querySelectorAll('.image-container img').forEach(image => {
                    image.onclick = () => {
                        document.getElementById('big1').style.display = 'block';
                        document.querySelector('.popup-pic img').src = image.getAttribute('src');
                    }
                });


                function creatAlert(email) {
                    var node = document.getElementById("textarea"),
                        ele = document.createElement("div");
                    ele.classList.add("alert")
                    ele.style.backgroundColor = "#F44336"
                    ele.style.color = "#FFFFFF"
                    ele.innerHTML = "<span class='closebtn'>&times;</span>\nInvalid Email: " + email
                    node.parentNode.parentNode.insertBefore(ele, document.getElementById("targeNode").nextSibling);
                    document.querySelector(".closebtn").addEventListener("click", gone)
                }

                function gone() {
                    div = document.querySelector(".alert")
                    div.parentNode.removeChild(div)
                }
        */

        const doorbellNameInput = document.getElementById('doorbell-name');
        const doorbellEmailsInput = document.getElementById('alert-emails');

        function checkDoorbellUpdateForm() {
            const name = doorbellNameInput.value;
            if (!name || !name.trim()) {
                alert('Please enter a name for your doorbell');
                return false;
            }

            const emails = doorbellEmailsInput.value;
            if (!emails || !emails.trim()) {
                alert('Please enter at least one email to alert');
                return false;
            }

            const emailsList = emails.split(/[,;\r\n ]/);
            for (let i = 0; i < emailsList.length; i++) {
                const email = emailsList[i];
                if (!email || !email.trim()) {
                    return;
                }

                if (!validateEmail(email)) {
                    alert('Please enter a valid email address');
                    return false;
                }
            }

            return true;
        }


        function openDoor() {
            fetch('{{ url_for('open_doorbell', uuid=doorbell.id) }}', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (!data || data.error) {
                        console.error(`Error while opening doorbell: ${data.error}`);
                        return;
                    }

                    console.debug(`Doorbell opened: ${data}`);
                })
                .catch(error => console.error(`Error while opening doorbell ${uuid}: ${error}`));
        }


        function takePic() {
            fetch('{{ url_for('take_picture', uuid=doorbell.id) }}', {method: 'POST'})
                .then(response => response.json())
                .then(data => {
                    if (!data || data.error) {
                        console.error(`Error while taking a picture: ${data.error}`);
                        return;
                    }

                    console.debug(`Picture taken: ${data}`);
                })
                .catch(error => console.error(`Error while taking a picture ${uuid}: ${error}`));
        }


        const inputTest = document.createElement('input');
        inputTest.type = 'email';

        function validateEmail(email) {
            inputTest.value = email;
            return inputTest.validity.typeMismatch === false;
        }


        const uuid = {{ doorbell.id }};
        const emails = [
            {% for email in doorbell.emails %}
                '{{ email }}',
            {% endfor %}
        ];
        const stream = document.getElementById('stream-view');
        window.addEventListener('load', () => {
            console.debug(emails);
            doorbellEmailsInput.value = emails.join('\r\n');
            if (stream) {
                stream.data = stream.getAttribute('url');
            }
        });
    </script>
{% endblock %}