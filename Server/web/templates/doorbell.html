{% extends 'default_e_bell.html' %}

{% set nav_title='Doorbell' %}

{% block e_bell_content %}
    <div class="align-items-baseline d-flex doorbell flex-wrap justify-content-evenly p-5 h-auto">
        <div class="card doorbell-detail-container">
            <div class="doorbell-detail-title card-body">
                <h2 class="card-title text-center">Stream</h2>
            </div>
            <object
                    width="320"
                    height="240"
                    class="doorbell-detail-stream img-fluid"
                    data="{{ doorbell.image }}"
                    {% if doorbell.online == True %}
                    id="stream-view"
                    url="{{ url_for('stream', uuid=doorbell.id) }}"
                    {% endif %}
                    type='image/jpeg'>
            </object>

            <div class="card-body d-flex flex-nowrap justify-content-evenly m-1 text-center w-auto">
                <button class="border-0 btn btn-cyan p-2 text-white w-35" onclick="takePic()" type="button" >Take Picture</button>
                <button class="border-0 btn btn-violet p-2 text-white w-35" onclick="OpenDoor()" type="button" >Open Door</button>
            </div>

        </div>
        <div class="card doorbell-detail-container">
            <div class="doorbell-detail-title card-body">
                <h2 class="card-title text-center">Details</h2>
            </div>
            <div class="card-body">
                <form action="{{ url_for('doorbell', uuid=doorbell.id) }}" method="POST">
                    <div class="form-group">
                        <label for="doorbell-name">Doorbell Name</label>
                        <input class="form-control" id="doorbell-name" name="doorbell-name"
                               placeholder="{{ doorbell.name }}" value="{{ doorbell.name }}" type="text"/>
                    </div>
                    <div class="form-group">
                        <label for="alert-emails">Emails to alert</label>
                        <textarea class="form-control" id="alert-emails"
                                  name="alert-emails">{% for email in doorbell.emails %}
                            {{ email }}{% endfor %}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="password">Password Confirmation</label>
                        <input class="form-control" id="password" placeholder="Password" name="password"
                               type="password">
                    </div>
                    <div class="d-flex flex-nowrap justify-content-evenly m-2 mt-4 text-center">
                        <button class="border-0 btn btn-green p-2 text-white w-25" type="submit">Submit</button>
                        <button class="border-0 btn btn-red p-2 text-white w-25" type="reset">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-6 col-md-4 col-lg-3 image-container">
               {# {% for path in paths %} #}
            <div class="col-sm-6 col-md-4 col-lg-3 image-container">
              <figure>
                  {# {% if ".mp4" in path %} #}
                    <div class="pic image"><video src='{# {{ path }} #}' class="img-thumbnail"></div>
                  {# {% else %} #}
                    <div class="pic image"><img src='{# {{ path }} #}' class="img-thumbnail"></div>
                  {# {% endif %}   #}
                  <figcaption>
                    {# {{ doorbells[loop.index0]}} #}</br>
                    {# {{ dates[loop.index0]}} #}
                  </figcaption>
              </figure>


            </div>
          {# {% endfor %} #}
            </div>
        </div>

    </div>
   

    <div class="popup-pic" id="big1">
        <span id="span1">&times;</span>
        <img src='{# {{ paths[0] }} #}' alt="">
    </div>
    <div class="popup-pic" id = "big2">
      <span id="span2">&times;</span>
      <video src='{# {{ paths[0] }} #}' alt="" controls>
    </div>


    <script>
        //IMGs
        document.querySelectorAll('.image-container img').forEach(image => {
            image.onclick = () => {
                document.getElementById('big1').style.display = 'block';
                document.querySelector('.popup-pic img').src = image.getAttribute('src');
            }
        });


        document.querySelectorAll('.image-container video').forEach(vid => {
            vid.onclick = () => {
                document.getElementById('big2').style.display = 'block';
                document.querySelector('.popup-pic video').src = vid.getAttribute('src');
            }
        });

        document.getElementById('span1').onclick = () =>{
            document.getElementById('big1').style.display = 'none';
        };
        document.getElementById('span2').onclick = () =>{
            document.getElementById('big2').style.display = 'none';
        };


        //BTNs
        function OpenDoor(){
            xmlHttpReq.open("GET", "{{ url_for('openDoor') }}", false); 
            xmlHttpReq.send(null);
            return xmlHttpReq.responseText;
        }

        function takePic(){


        }

        function getText() {
            if ((document.getElementById("textarea").value == name.defaultValue && document.getElementById("username").value) || document.getElementById("password").value) //this checks for changes to form, needs testing
                return
            var text = document.getElementById("textarea").value;
            var words = text.split(/\r?\n/);
            for (i in words) {
                if (!validateEmail(words[i]))
                    creatAlert(words[i])
                return;
        }
    }




    //Alert

    function validateEmail (email){ //this function is not working, always returns false
        console.log(email)
        return email.match(/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/);
        };

    function creatAlert(email){
        var node = document.getElementById("textarea"),
        ele = document.createElement("div");
        ele.classList.add("alert")
        ele.style.backgroundColor = "#F44336"
        ele.style.color = "#FFFFFF"
        ele.innerHTML = "<span class='closebtn'>&times;</span>\nInvalid Email: " + email
        node.parentNode.parentNode.insertBefore(ele, document.getElementById("targeNode").nextSibling);
        document.querySelector(".closebtn").addEventListener("click", gone)
    }

        function gone() {
            div = document.querySelector(".alert")
            div.parentNode.removeChild(div)
        }


        //missing a post with the new data that sends password to comfirm identity
    </script>
{% endblock %}

{% block scripts %}
    <script>
        window.addEventListener('load', function () {
            const stream = document.getElementById('stream-view');
            if (stream) {
                stream.data = stream.getAttribute('url');
            }
        });
    </script>
{% endblock %}